# OmniAgent

**å¤šæ¨¡å—æ™ºèƒ½ Agent å¹³å°**ï¼Œé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œæ”¯æŒå¤šç§ Agent å®ä¾‹æ¥å…¥ä¸åŒçš„é€šè®¯æ¸ é“ï¼ˆé£ä¹¦ã€å¾®ä¿¡ã€Web ç­‰ï¼‰ã€‚

## é¡¹ç›®æ¦‚è¿°

OmniAgent æ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„ Agent å¹³å°ï¼Œæ ¸å¿ƒç†å¿µæ˜¯ï¼š

- **å¹³å°åŒ–**ï¼šç»Ÿä¸€çš„ Agent åŸºç¡€è®¾æ–½ï¼ˆæŠ€èƒ½ç³»ç»Ÿã€è®°å¿†ç³»ç»Ÿã€äººæ ¼ç³»ç»Ÿï¼‰
- **å¤šå®ä¾‹**ï¼šæ”¯æŒå¤šä¸ª Agent å®ä¾‹ï¼Œå„è‡ªç‹¬ç«‹é…ç½®
- **å¤šé€šé“**ï¼šé€šè¿‡é€‚é…å™¨æ¥å…¥ä¸åŒçš„é€šè®¯å¹³å°

### å½“å‰æ¨¡å—

| æ¨¡å— | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **Feishu Agent** | é£ä¹¦æœºå™¨äºº Agentï¼Œé¢å‘å¾‹å¸ˆåœºæ™¯ | âœ… å¼€å‘ä¸­ |
| **MCP Feishu Server** | é£ä¹¦ API å·¥å…·å±‚ï¼ˆå¤šç»´è¡¨æ ¼ã€æ–‡æ¡£ï¼‰ | âœ… å¼€å‘ä¸­ |
| *Web Agent* | Web èŠå¤©ç•Œé¢ Agent | ğŸ“‹ è§„åˆ’ä¸­ |
| *WeChat Agent* | å¾®ä¿¡æœºå™¨äºº Agent | ğŸ“‹ è§„åˆ’ä¸­ |

---

## æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **Skill æŠ€èƒ½ç³»ç»Ÿ** | è§„åˆ™ä¼˜å…ˆ + LLM å…œåº•ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ã€æŠ€èƒ½å¸‚åœºæ‰©å±• |
| **Soul äººæ ¼ç³»ç»Ÿ** | `SOUL.md` + `IDENTITY.md`ï¼Œæ”¯æŒçƒ­æ›´æ–° |
| **Memory è®°å¿†ç³»ç»Ÿ** | åˆ†å±‚è®°å¿†ï¼ˆå…±äº« + ç”¨æˆ·éš”ç¦»ï¼‰ï¼Œæ”¯æŒå‘é‡æ£€ç´¢ |
| **MCP å·¥å…·å±‚** | æ ‡å‡†åŒ–å·¥å…·è°ƒç”¨åè®®ï¼Œå¯¹æ¥é£ä¹¦å¤šç»´è¡¨æ ¼ç­‰ |

---

## åŒç»„ç»‡å‡­è¯æ¶æ„

- MCP Feishu Serverï¼ˆç»„ç»‡Aï¼‰ï¼šæŒæœ‰ data å‡­è¯ï¼Œè´Ÿè´£å¤šç»´è¡¨æ ¼/æ–‡æ¡£è®¿é—®
- Feishu Agentï¼ˆç»„ç»‡Bï¼‰ï¼šæŒæœ‰ bot å‡­è¯ï¼Œè´Ÿè´£ Webhook éªŒç­¾ä¸æ¶ˆæ¯å‘é€
- å…¸å‹æµç¨‹ï¼šç”¨æˆ· -> ç»„ç»‡B Webhook -> Agent -> MCP -> ç»„ç»‡A æ•°æ® -> Agent -> ç»„ç»‡B å›å¤
- å…³é”®ç¯å¢ƒå˜é‡ï¼š`FEISHU_DATA_*`ï¼ˆMCPï¼‰ä¸ `FEISHU_BOT_*`ï¼ˆAgentï¼‰

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              é€šè®¯æ¸ é“                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â”‚  é£ä¹¦    â”‚    â”‚  å¾®ä¿¡    â”‚    â”‚   Web    â”‚   ...                  â”‚
â”‚         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚               â”‚               â”‚
               â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Agent å®ä¾‹å±‚                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚ Feishu Agent   â”‚  â”‚ WeChat Agent   â”‚  â”‚  Web Agent     â”‚   ...          â”‚
â”‚   â”‚ (å¾‹å¸ˆåŠ©æ‰‹)      â”‚  â”‚ (å¾…å¼€å‘)        â”‚  â”‚ (å¾…å¼€å‘)        â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            å…±äº«åŸºç¡€è®¾æ–½                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ Skill ç³»ç»Ÿ   â”‚  â”‚ Soul ç³»ç»Ÿ    â”‚  â”‚ Memory ç³»ç»Ÿ  â”‚  â”‚ MCP Server   â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                               â”‚
             â–¼                                               â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  LLM æœåŠ¡    â”‚                              â”‚  æ•°æ®å­˜å‚¨     â”‚
      â”‚ (OpenAIç­‰)   â”‚                              â”‚ (PG/Chroma)  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç›®å½•ç»“æ„

```
OmniAgent/
â”œâ”€â”€ agent/                          # Agent å®ä¾‹ç›®å½•
â”‚   â””â”€â”€ feishu-agent/               # é£ä¹¦ Agentï¼ˆå½“å‰å¼€å‘é‡ç‚¹ï¼‰
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ api/                # API å…¥å£ï¼ˆwebhook/websocketï¼‰
â”‚       â”‚   â”œâ”€â”€ core/               # æ ¸å¿ƒæ¨¡å—
â”‚       â”‚   â”‚   â”œâ”€â”€ orchestrator.py # ç¼–æ’å™¨
â”‚       â”‚   â”‚   â”œâ”€â”€ intent/         # æ„å›¾è§£æ
â”‚       â”‚   â”‚   â”œâ”€â”€ router/         # æŠ€èƒ½è·¯ç”±
â”‚       â”‚   â”‚   â”œâ”€â”€ skills/         # æŠ€èƒ½å®ç°ï¼ˆQuery/Create/Summary/Reminder/Chitchatï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ soul/           # äººæ ¼ç³»ç»Ÿ
â”‚       â”‚   â”‚   â””â”€â”€ memory/         # è®°å¿†ç³»ç»Ÿ
â”‚       â”‚   â”œâ”€â”€ llm/                # LLM å®¢æˆ·ç«¯
â”‚       â”‚   â””â”€â”€ mcp/                # MCP å®¢æˆ·ç«¯
â”‚       â”œâ”€â”€ config/                 # é…ç½®æ–‡ä»¶
â”‚       â”œâ”€â”€ workspace/              # è¿è¡Œæ—¶æ•°æ®ï¼ˆè®°å¿†ã€æ—¥å¿—ï¼‰
â”‚       â””â”€â”€ run_server.py           # å¯åŠ¨è„šæœ¬
â”‚
â”œâ”€â”€ mcp/                            # MCP å·¥å…·æœåŠ¡
â”‚   â””â”€â”€ mcp-feishu-server/          # é£ä¹¦ MCP Server
â”‚       â”œâ”€â”€ src/
â”‚       â””â”€â”€ run_server.py
â”‚
â”œâ”€â”€ monitoring/                     # ç›‘æ§é…ç½®
â”œâ”€â”€ docs/                           # æ–‡æ¡£
â”œâ”€â”€ docs/DEV_PLAN.md                # å¼€å‘è®¡åˆ’
â”œâ”€â”€ docs/TASK.md                    # ä»»åŠ¡è¿½è¸ª
â””â”€â”€ docker-compose.yml              # Docker ç¼–æ’
```

## è¯·æ±‚æµç¨‹ç¤ºä¾‹

```
ç”¨æˆ·: "å¸®æˆ‘æ€»ç»“ä»Šå¤©å¼€åº­çš„æ¡ˆå­"
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Soul æ³¨å…¥    â”‚ â† è¯»å– SOUL.md + IDENTITY.md
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Memory åŠ è½½   â”‚ â† è¯»å–å…±äº«è®°å¿† + ç”¨æˆ·è®°å¿† + æœ€è¿‘ 2 å¤©æ—¥å¿—
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ IntentParser  â”‚ â† è§„åˆ™å‘½ä¸­: Query(0.85) + Summary(0.80)
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ SkillChain    â”‚ â† [QuerySkill, SummarySkill]
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ QuerySkill    â”‚ â† è°ƒç”¨ MCPï¼Œå†™å…¥ context.last_result
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ SummarySkill  â”‚ â† è°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Memory å†™å…¥   â”‚ â† è®°å½•åˆ°æ¯æ—¥æ—¥å¿—
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ è¿”å›é£ä¹¦      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¥å£

```python
@dataclass
class IntentResult:
    top_skills: List[SkillMatch]
    is_chain: bool = False
    requires_llm_confirm: bool = False

@dataclass
class SkillResult:
    success: bool
    data: Any = None
    message: str = ""
    next_skill: Optional[str] = None
    confidence: Optional[float] = None
    citations: Optional[List[str]] = None

@dataclass
class Context:
    user_id: str
    message: str
    soul_prompt: str
    shared_memory: str
    user_memory: str
    recent_logs: str
    last_result: Optional[Any] = None
    last_skill: Optional[str] = None
```

---

## Workspace

- `agent/feishu-agent/workspace/SOUL.md`ï¼šäººæ ¼å‡†åˆ™
- `agent/feishu-agent/workspace/IDENTITY.md`ï¼šå¯¹å¤–èº«ä»½
- `agent/feishu-agent/workspace/MEMORY.md`ï¼šå›¢é˜Ÿå…±äº«è®°å¿†
- `agent/feishu-agent/workspace/users/{open_id}/`ï¼šç”¨æˆ·éš”ç¦»è®°å¿†

é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºä¸Šè¿°æ–‡ä»¶ä¸ç›®å½•ã€‚

---

## é…ç½®æ–‡ä»¶

### skills.yaml

```yaml
intent:
  thresholds:
    direct_execute: 0.7
    llm_confirm: 0.4
  llm_timeout: 10

query:
  keywords: [æŸ¥, æ‰¾, æœç´¢, æ¡ˆä»¶, å¼€åº­]

summary:
  keywords: [æ€»ç»“, æ±‡æ€», æ¦‚æ‹¬]
  default_fields: [æ¡ˆå·, æ¡ˆç”±, å½“äº‹äºº, å¼€åº­æ—¥, ä¸»åŠå¾‹å¸ˆ]

reminder:
  keywords: [æé†’, è®°å¾—, åˆ«å¿˜äº†]

chain:
  triggers:
    - pattern: "(æŸ¥|æ‰¾).*(æ€»ç»“|æ±‡æ€»)"
      skills: [QuerySkill, SummarySkill]
  max_hops: 2
```

### prompts.yaml

```yaml
intent_parser:
  system: |
    ä½ æ˜¯ä¸€ä¸ªæ„å›¾åˆ†ç±»å™¨ã€‚æ ¹æ®ç”¨æˆ·è¾“å…¥ï¼Œåˆ¤æ–­æœ€åŒ¹é…çš„æŠ€èƒ½ã€‚

summary:
  system: |
    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¾‹å¸ˆåŠ©ç†ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ¡ˆä»¶æŸ¥è¯¢ç»“æœï¼Œç”Ÿæˆç®€æ´çš„æ‘˜è¦ã€‚
```

---

## å¼€å‘é˜¶æ®µ

| é˜¶æ®µ | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| Phase 1 | åŸºç¡€æ¡†æ¶ | âœ… å®Œæˆ |
| Phase 2 | Soul äººæ ¼ç³»ç»Ÿ | âœ… å®Œæˆ |
| Phase 3 | Memory è®°å¿†ç³»ç»Ÿ | âœ… å®Œæˆ |
| Phase 4 | Skill ç³»ç»Ÿå®Œå–„ | âœ… å®Œæˆ |
| Phase 5 | é›†æˆä¸ç¼–æ’ | âœ… å®Œæˆ |
| Phase 6 | æµ‹è¯•ä¸ç›‘æ§ | âœ… å®Œæˆ |

è¯¦ç»†ä»»åŠ¡è¿›åº¦è§ `docs/TASK.md`ã€‚

---

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.11+
- PostgreSQL 14+ï¼ˆReminder éœ€è¦ï¼‰
- é£ä¹¦å¼€æ”¾å¹³å°åº”ç”¨ï¼ˆæœºå™¨äººèƒ½åŠ›ï¼‰

### å¯åŠ¨ MCP Server

```bash
cd mcp/mcp-feishu-server
pip install -r requirements.txt
uvicorn src.main:app --port 8081
```

### å¯åŠ¨ Feishu Agent

```bash
cd agent/feishu-agent
pip install -r requirements.txt
uvicorn src.main:app --port 8080
```

---

## ç›‘æ§ä¸å¯è§†åŒ–

- æŒ‡æ ‡ç«¯ç‚¹ï¼š`/metrics`
- Prometheus é…ç½®ï¼š`monitoring/prometheus.yml`
- Grafana ä»ªè¡¨ç›˜ï¼š`monitoring/grafana/dashboards/omniagent.json`

### è¿è¡Œè„šæœ¬

```bash
./monitoring/run_monitoring.sh
```

```powershell
./monitoring/run_monitoring.ps1
```

## æµ‹è¯•è¦†ç›–ç‡

```bash
./scripts/run_coverage.sh
```

```powershell
./scripts/run_coverage.ps1
```

### å¯é€‰éƒ¨ç½²ï¼ˆdocker-composeï¼‰

```yaml
# prometheus + grafana ä¹Ÿå¯é€šè¿‡ monitoring/docker-compose.monitoring.yml å¯åŠ¨
```

---

## æ•°æ®åº“

```sql
CREATE TABLE reminders (
    id              SERIAL PRIMARY KEY,
    user_id         VARCHAR(64) NOT NULL,
    chat_id         VARCHAR(64),
    content         TEXT NOT NULL,
    due_at          TIMESTAMP,
    priority        VARCHAR(16) DEFAULT 'medium',
    status          VARCHAR(16) DEFAULT 'pending',
    retry_count     INT DEFAULT 0,
    last_error      TEXT,
    notified_at     TIMESTAMP,
    locked_by       VARCHAR(64),
    locked_at       TIMESTAMP,
    created_at      TIMESTAMP DEFAULT NOW(),
    updated_at      TIMESTAMP DEFAULT NOW()
);
```
