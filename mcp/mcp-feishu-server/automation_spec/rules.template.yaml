# 自动化规则模板 v1.2（与当前实现对齐）
# 说明：本文件仅供评审与参考，不会被运行时直接加载。

meta:
  version: "v1.2"
  status: aligned
  owner: automation
  reviewed_at: "2026-02"
  notes:
    - "运行时默认 status_write_enabled=false（仅日志）"
    - "watched_fields 默认可自动从 rules 提取"

# 可选手工 watched_fields（不配也可）
watched_fields:
  tbl_xxx:
    - 案件分类
    - 开庭日
    - 委托人

rules:
  - rule_id: R001
    name: "示例-案件分类改为劳动争议"
    enabled: false
    priority: 100

    table:
      table_id: tbl_xxx
      table_name: 案件项目总库

    trigger:
      field: 案件分类
      condition:
        changed: true
        equals: 劳动争议
        old_not_equals_new: true

    guard:
      idempotency_scope: business
      dedupe_keys: [record_id, table_id, field_hash]
      cooldown_seconds: 0

    pipeline:
      actions:
        - type: log.write
          level: info
          message: "规则命中：{record_id} 案件分类={案件分类}"

        # 可选：需要建日历时启用
        # - type: calendar.create
        #   summary_template: "劳动争议案件跟进：{案号}"
        #   description_template: "委托人：{委托人}"
        #   start_field: 开庭日
        #   duration_minutes: 30

      # 可选：仅当 status_write_enabled=true 时建议配置
      # before_actions:
      #   - type: bitable.update
      #     fields:
      #       自动化_执行状态: 处理中
      #       自动化_最近错误: ""
      # success_actions:
      #   - type: bitable.update
      #     fields:
      #       自动化_执行状态: 成功
      #       自动化_最近错误: ""
      # error_actions:
      #   - type: bitable.update
      #     fields:
      #       自动化_执行状态: 失败
      #       自动化_最近错误: "{error}"

    observability:
      run_log_enabled: true
      dead_letter_on_failure: true
      log_fields:
        - event_id
        - rule_id
        - table_id
        - record_id
        - trigger_field
        - result
        - retry_count
        - duration_ms

  - rule_id: R002
    name: "示例-任意字段变更（排除字段）"
    enabled: false
    priority: 10

    table:
      table_id: tbl_xxx
      table_name: 案件项目总库

    trigger:
      any_field_changed: true
      exclude_fields:
        - 自动化_执行状态
        - 自动化_最近错误
        - 自动化_最后触发时间

    pipeline:
      actions:
        - type: log.write
          level: info
          message: "任意字段变更：{record_id}"
