# ============================================================
# Feishu Agent é…ç½®æ–‡ä»¶
# ============================================================
# ä½¿ç”¨æ–¹å¼ï¼š
#   1. å¤åˆ¶æ­¤æ–‡ä»¶ä¸º config.yaml
#   2. ä¿®æ”¹é…ç½®é¡¹æˆ–é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–
#   3. ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶
# ============================================================

# ------------------------------------------------------------
# æœåŠ¡é…ç½®
# ------------------------------------------------------------
server:
  host: "0.0.0.0"
  port: 8080
  workers: 1                      # 1C2G å»ºè®®å• worker
  debug: false

# ------------------------------------------------------------
# é£ä¹¦æœºå™¨äººé…ç½®
# ------------------------------------------------------------
feishu:
  # åº”ç”¨å‡­è¯ï¼ˆå¿…å¡«ï¼‰
  app_id: ${FEISHU_BOT_APP_ID}
  app_secret: ${FEISHU_BOT_APP_SECRET}

  # Webhook éªŒè¯é…ç½®
  verification_token: ${FEISHU_BOT_VERIFICATION_TOKEN}
  encrypt_key: ${FEISHU_BOT_ENCRYPT_KEY:-}    # å¯é€‰ï¼Œå¯ç”¨æ¶ˆæ¯åŠ å¯†æ—¶éœ€è¦

  # API åŸºç¡€åœ°å€
  api_base: "https://open.feishu.cn/open-apis"

  # æ¶ˆæ¯é…ç½®
  message:
    # å›å¤è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    reply_timeout: 30
    # æ˜¯å¦ä½¿ç”¨ reply æ¨¡å¼ï¼ˆå¼•ç”¨åŸæ¶ˆæ¯ï¼‰
    use_reply_mode: true

# ------------------------------------------------------------
# MCP Server é…ç½®
# ------------------------------------------------------------
mcp:
  # MCP Server åœ°å€
  base_url: ${MCP_SERVER_BASE:-http://localhost:8081}

  # è¯·æ±‚é…ç½®
  request:
    timeout: 30                   # è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰
    max_retries: 2                # æœ€å¤§é‡è¯•æ¬¡æ•°
    retry_delay: 1                # é‡è¯•é—´éš”ï¼ˆç§’ï¼‰

# ------------------------------------------------------------
# PostgreSQL é…ç½®
# ------------------------------------------------------------
postgres:
  dsn: ${POSTGRES_DSN:-}           # ä¾‹å¦‚: postgresql://user:pass@localhost:5432/omniagent
  min_size: 1
  max_size: 5
  timeout: 10

# æé†’è°ƒåº¦è½®è¯¢ï¼ˆé»˜è®¤å…³é—­ï¼Œå‡å°‘å¼€å‘æ€å™ªéŸ³ä¸ DB ä¾èµ–ï¼‰
reminder_scheduler_enabled: ${REMINDER_SCHEDULER_ENABLED:-false}

# ------------------------------------------------------------
# LLM é…ç½®
# ------------------------------------------------------------
llm:
  # ä¸»æ¨¡å‹é…ç½®
  provider: "openai"              # openai | anthropic | deepseek
  model: "gpt-4o-mini"            # æ¨èæ€§ä»·æ¯”æ¨¡å‹

  # API é…ç½®
  api_key: ${LLM_API_KEY}
  api_base: ${LLM_API_BASE:-}     # å¯é€‰ï¼Œè‡ªå®šä¹‰ API åœ°å€ï¼ˆä»£ç†ï¼‰

  # ç”Ÿæˆå‚æ•°
  temperature: 0.3                # åç¡®å®šæ€§è¾“å‡º
  max_tokens: 2000                # å•æ¬¡æœ€å¤§ç”Ÿæˆ token

  # è¯·æ±‚é…ç½®
  timeout: 60                     # LLM è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰
  max_retries: 2

  # å¤‡ç”¨æ¨¡å‹ï¼ˆå¯é€‰ï¼Œä¸»æ¨¡å‹å¤±è´¥æ—¶åˆ‡æ¢ï¼‰
  fallback:
    enabled: false
    provider: "deepseek"
    model: "deepseek-chat"
    api_key: ${LLM_FALLBACK_API_KEY:-}
    api_base: "https://api.deepseek.com/v1"

# ------------------------------------------------------------
# ä»»åŠ¡æ¨¡å‹é…ç½®ï¼ˆæ„å›¾è¯†åˆ«/å·¥å…·è°ƒç”¨ä¸“ç”¨ï¼Œå¯é€‰ï¼‰
# ------------------------------------------------------------
# å¯ç”¨åï¼ŒPlanner æ„å›¾è¯†åˆ«å’Œå·¥å…·å‚æ•°æå–èµ°æ­¤æ¨¡å‹ï¼Œ
# ChitchatSkill ç­‰å¯¹è¯åœºæ™¯ä»èµ°ä¸Šæ–¹ä¸»æ¨¡å‹ã€‚
# æœªå¯ç”¨æ—¶æ‰€æœ‰ç¯èŠ‚å…±äº«ä¸»æ¨¡å‹ï¼Œè¡Œä¸ºä¸å˜ã€‚
task_llm:
  enabled: ${TASK_LLM_ENABLED:-false}
  provider: "minimax"
  model: ${TASK_LLM_MODEL:-MiniMax-M2.5}
  api_key: ${TASK_LLM_API_KEY:-}
  api_base: ${TASK_LLM_API_BASE:-}

# ------------------------------------------------------------
# Agent é…ç½®
# ------------------------------------------------------------
agent:
  # Agent åç§°ï¼ˆç”¨äºæ—¥å¿—æ ‡è¯†ï¼‰
  name: "feishu-case-assistant"

  # ç³»ç»Ÿæç¤ºè¯é…ç½®
  prompt:
    # è§’è‰²å®šä¹‰
    role: |
      ä½ æ˜¯ä¸€ä¸ªæ³•å¾‹äº‹åŠ¡åŠ©æ‰‹ï¼Œå¸®åŠ©å¾‹å¸ˆæŸ¥è¯¢å’Œç®¡ç†æ¡ˆä»¶ä¿¡æ¯ã€‚
      ä½ å¯ä»¥æŸ¥è¯¢è¯‰è®¼æ¡ˆä»¶çš„å¼€åº­æ—¥æœŸã€æ¡ˆå·ã€å½“äº‹äººç­‰ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥æœç´¢ç›¸å…³æ³•å¾‹æ–‡æ¡£ã€‚

    # èƒ½åŠ›è¯´æ˜
    capabilities: |
      - æŸ¥è¯¢è¯‰è®¼æ¡ˆä»¶ä¿¡æ¯ï¼ˆå¼€åº­å®‰æ’ã€æ¡ˆä»¶çŠ¶æ€ã€å½“äº‹äººç­‰ï¼‰
      - æœç´¢æ³•å¾‹æ–‡æ¡£
      - å›ç­”æ¡ˆä»¶ç›¸å…³é—®é¢˜

    # é™åˆ¶è¯´æ˜
    constraints: |
      - åªèƒ½æŸ¥è¯¢ç³»ç»Ÿä¸­å·²æœ‰çš„æ•°æ®ï¼Œä¸è¦ç¼–é€ ä¿¡æ¯
      - å¦‚æœæŸ¥è¯¢æ— ç»“æœï¼Œç¤¼è²Œå‘ŠçŸ¥ç”¨æˆ·
      - æ¶‰åŠæ•æ„Ÿä¿¡æ¯æ—¶æ³¨æ„ä¿å¯†

    # è¾“å‡ºæ ¼å¼è¯´æ˜
    output_format: |
      - å›å¤åº”ç®€æ´ã€ç»“æ„åŒ–
      - æ¡ˆä»¶åˆ—è¡¨ä½¿ç”¨ç¼–å·å’Œè¡¨æƒ…ç¬¦å·
      - åŒ…å«å…³é”®å­—æ®µå’Œè®°å½•é“¾æ¥
      - æ—¥æœŸä½¿ç”¨æ˜“è¯»æ ¼å¼

  # å·¥å…·è°ƒç”¨é…ç½®
  tools:
    # æœ€å¤§å·¥å…·è°ƒç”¨è½®æ¬¡ï¼ˆé˜²æ­¢æ­»å¾ªç¯ï¼‰
    max_iterations: 5
    # æ˜¯å¦å¹¶è¡Œè°ƒç”¨å·¥å…·
    parallel_calls: false

# ------------------------------------------------------------
# ä¼šè¯é…ç½®
# ------------------------------------------------------------
session:
  # ä¸Šä¸‹æ–‡çª—å£ï¼ˆä¿ç•™æœ€è¿‘ N è½®å¯¹è¯ï¼‰
  max_rounds: 5

  # ä¼šè¯è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  ttl_minutes: 30

  # Token é¢„ç®—ï¼ˆå«ä¸Šä¸‹æ–‡ï¼Œé¿å…è¶…å‡ºæ¨¡å‹é™åˆ¶ï¼‰
  max_context_tokens: 4000

  # æ¸…ç†é…ç½®
  cleanup:
    # æ¸…ç†æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
    interval_seconds: 300
    # æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ¸…ç†
    enabled: true

# ------------------------------------------------------------
# Webhook é…ç½®
# ------------------------------------------------------------
webhook:
  # è·¯å¾„é…ç½®
  path: "/feishu/webhook"

  # äº‹ä»¶å»é‡
  dedup:
    enabled: true
    # å»é‡ç¼“å­˜ TTLï¼ˆç§’ï¼‰
    ttl_seconds: 300
    # æœ€å¤§ç¼“å­˜æ•°é‡
    max_size: 10000

  # æ¶ˆæ¯è¿‡æ»¤
  filter:
    # ä»…å¤„ç†çš„æ¶ˆæ¯ç±»å‹
    allowed_message_types:
      - "text"
    # ä»…å¤„ç†ç§èŠ
    private_chat_only: true
    # å¿½ç•¥æœºå™¨äººè‡ªèº«æ¶ˆæ¯
    ignore_bot_message: true

  # åˆ†ç‰‡èšåˆï¼ˆå¤šæ¡çŸ­æ¶ˆæ¯ 3 ç§’çª—å£èšåˆï¼‰
  chunk_assembler:
    enabled: ${CHUNK_ASSEMBLER_ENABLED:-false}
    window_seconds: 3
    stale_window_seconds: ${CHUNK_ASSEMBLER_STALE_WINDOW_SECONDS:-10}
    max_segments: 5
    max_chars: 500

# ------------------------------------------------------------
# å›å¤æ ¼å¼é…ç½®
# ------------------------------------------------------------
reply:
  # å›å¤æ¨¡æ¿
  templates:
    # æ— ç»“æœ
    no_result: "æœªæ‰¾åˆ°ç›¸å…³è®°å½•ï¼Œè¯·å°è¯•è°ƒæ•´æŸ¥è¯¢æ¡ä»¶ã€‚"
    # å—é™èŠå¤©å¼•å¯¼
    guide: "ç›®å‰ä»…æ”¯æŒæ¡ˆä»¶/æ–‡æ¡£æŸ¥è¯¢ï¼Œå¯è¯•è¯•ï¼š\"æ‰¾ä¸€ä¸‹æå››çš„æ¡ˆå­\" æˆ– \"1æœˆ28å·æœ‰ä»€ä¹ˆåº­è¦å¼€\"ã€‚"
    # é—²èŠé—®å€™
    small_talk: "ä½ å¥½ï¼æˆ‘å¯ä»¥å¸®ä½ æŸ¥è¯¢æ¡ˆä»¶æˆ–æ–‡æ¡£ã€‚"
    # æ„Ÿè°¢å›å¤
    thanks: "ä¸å®¢æ°”ï¼éœ€è¦æŸ¥è¯¢æ¡ˆä»¶æˆ–æ–‡æ¡£éšæ—¶å‘Šè¯‰æˆ‘ã€‚"
    # å‘Šåˆ«
    goodbye: "å¥½çš„ï¼Œå¦‚éœ€æŸ¥è¯¢éšæ—¶æ‰¾æˆ‘ã€‚"
    # é”™è¯¯æç¤º
    error: "æŠ±æ­‰ï¼Œå¤„ç†è¯·æ±‚æ—¶é‡åˆ°é—®é¢˜ï¼š{message}"
    # è¶…æ—¶æç¤º
    timeout: "æ€è€ƒè¶…æ—¶ï¼Œè¯·ç®€åŒ–é—®é¢˜åé‡è¯•ã€‚"
    # æ¬¢è¿è¯­
    welcome: |
      ä½ å¥½ï¼æˆ‘æ˜¯æ¡ˆä»¶åŠ©æ‰‹ï¼Œå¯ä»¥å¸®ä½ ï¼š
      ğŸ“… æŸ¥è¯¢å¼€åº­å®‰æ’
      ğŸ“‹ æŸ¥è¯¢æ¡ˆä»¶ä¿¡æ¯
      ğŸ“„ æœç´¢æ³•å¾‹æ–‡æ¡£

      è¯•è¯•é—®æˆ‘ï¼š"è¿™å‘¨æœ‰ä»€ä¹ˆåº­è¦å¼€ï¼Ÿ"

  # æ¡ˆä»¶åˆ—è¡¨æ ¼å¼
  case_list:
    # æ ‡é¢˜æ¨¡æ¿
    title: "ğŸ“Œ æ¡ˆä»¶æŸ¥è¯¢ç»“æœï¼ˆå…± {count} æ¡ï¼‰"
    # å•æ¡è®°å½•æ¨¡æ¿
    item: |
      {index}ï¸âƒ£ {client} vs {opponent}ï½œ{cause}
         â€¢ æ¡ˆå·ï¼š{case_number}
         â€¢ æ³•é™¢ï¼š{court}
         â€¢ ç¨‹åºï¼š{stage}
         â€¢ ğŸ”— æŸ¥çœ‹è¯¦æƒ…ï¼š{record_url}

# ------------------------------------------------------------
# æ—¥å¿—é…ç½®
# ------------------------------------------------------------
logging:
  level: "INFO"                   # DEBUG | INFO | WARNING | ERROR
  format: "json"                  # json | text

  # æ—¥å¿—è¾“å‡º
  output:
    console: true
    file:
      enabled: false
      path: "logs/feishu-agent.log"
      max_size_mb: 100
      backup_count: 5

  # æ•æ„Ÿä¿¡æ¯è„±æ•
  mask:
    enabled: true
    fields:
      - "app_secret"
      - "api_key"
      - "encrypt_key"

# ------------------------------------------------------------
# é™æµé…ç½®
# ------------------------------------------------------------
rate_limit:
  enabled: true
  # å•ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°
  user_rpm: 30
  # å…¨å±€æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°
  global_rpm: 300
  # æœ€å¤§å¹¶å‘æ•°
  max_concurrency: 10

# ------------------------------------------------------------
# å¥åº·æ£€æŸ¥é…ç½®
# ------------------------------------------------------------
health:
  # å¥åº·æ£€æŸ¥è·¯å¾„
  path: "/health"
  # æ˜¯å¦æ£€æŸ¥ä¾èµ–æœåŠ¡
  check_dependencies: true
  # ä¾èµ–æœåŠ¡åˆ—è¡¨
  dependencies:
    - name: "mcp-server"
      url: "${MCP_SERVER_BASE}/health"
      timeout: 5
