# OmniAgent 测试记录（失败项精简版）

> 最后更新：2026-02-09

## 当前失败项（已简化保留）

| 原测试 | 问题简述 | 现象（精简） | 初步定位 |
| --- | --- | --- | --- |
| 测试 2："我的案件"查询 | 人员字段过滤失败 | `search_person` 返回 `InvalidFilter`（1254018） | `open_id` 或人员过滤参数格式不符合飞书接口要求 |
| 测试 4：日期范围查询 | 日期过滤表达式不兼容 | `search_date_range` 返回 `InvalidFilter`（1254018） | 日期字段类型不支持当前 `isGreaterEqual` 过滤方式 |
| 测试 5：关键词查询 | 检索范围不足 | 仅能命中部分主办律师相关记录，委托人/项目ID命中不稳定 | 关键词路由和字段优先级策略需要调整 |
| 测试 7：提醒功能 | 数据库认证失败 | 保存提醒时报错：`password authentication failed for user "omniagent"` | 本地数据库账号/密码或连接配置错误 |
| 测试 8：错误处理 | 无意义输入未被拦截 | 对乱码/无关文本进行了正常闲聊回复 | 意图识别边界与拒答策略缺失 |
| API 连通性（8080） | Agent 服务未启动 | `curl http://localhost:8080/health` 连接失败 | Feishu Agent 进程未运行或端口未监听 |

## 已删除内容说明

- 已删除所有“测试成功/正常输出”项。
- 已删除冗长原始日志，仅保留定位所需的关键信息。

## 自动化测试用例表（评审版）

| 用例ID | 前置条件 | 操作步骤 | 预期结果 | 失败定位 |
| --- | --- | --- | --- | --- |
| AUTO-01 文档字段完整性 | 已有 `automation_spec` | 按 `contracts -> rules -> validation` 检查 | 事件字段含 `table_id/record_id/event_id` | 先修 `events.sample.json` 的 `contracts` |
| AUTO-02 规则模板覆盖 | 有业务规则清单 | 核对“字段变更/任意字段/排除字段”模板 | 三类模板均可映射业务 | 在 `rules.template.yaml` 补模板 |
| AUTO-03 状态字段约定 | 文档可编辑 | 核对 `自动化_执行状态`、`自动化_最近错误` | 两字段存在且状态枚举明确 | 在 `fields.yaml` `validation` 补契约 |
| AUTO-04 快照差异计算 | 已恢复自动化代码 | 构造 old/new 跑 `snapshot.diff` | 正确区分新增/变更/未变更 | 检查字段归一化与类型转换 |
| AUTO-05 规则命中判断 | 有规则样例 | 输入命中与不命中事件各一组 | 命中可复现且不误触发 | 检查条件解析与字段路径 |
| AUTO-06 事件幂等 | 支持事件去重存储 | 同一 `event_id` 重放两次 | 第二次不执行动作 | 检查 event key 生成和 TTL |
| AUTO-07 成功链路 | 测试表与规则已配置 | 改“案件分类 -> 劳动争议” | 状态 `处理中 -> 成功` | 检查字段回写权限/字段名 |
| AUTO-08 失败可见性 | 可人为制造动作失败 | 触发同一规则 | 状态=失败，最近错误有原因 | 检查异常透传与截断逻辑 |
| AUTO-09 challenge 校验 | 回调地址可访问 | 事件订阅 challenge | challenge 成功返回 | 检查签名校验与响应格式 |
| AUTO-10 回调处理链路 | ngrok/公网回调可用 | 改表并观察日志 | 日志顺序：收到事件->匹配规则->动作结果 | 从中断环节逐段排查 |
| AUTO-11 轮询补偿 | 支持切换事件/轮询 | 仅开轮询后改表 | 轮询仍可触发动作 | 检查扫描窗口与游标推进 |
| AUTO-12 失败不死循环 | 可注入失败动作 | 连续触发失败场景 | 错误可见、重试受控 | 检查退避策略与最大重试 |
| AUTO-13 灰度验证 | 至少1条低风险规则 | 灰度运行1天后扩规则 | 无异常堆积，成功率稳定 | 回看失败样本与规则粒度 |
